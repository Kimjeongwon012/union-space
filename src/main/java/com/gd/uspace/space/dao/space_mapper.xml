<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC	"-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gd.uspace.space.dao.SpaceDAO">

	<!-- 장소 상태 변경 & 장소 삭제 -->
	<update id="updateSpaceStatus" >
		UPDATE space 
			SET space_status = #{param2}
			WHERE space_no = #{param1}
	</update>
	
	<!-- 장소 전체 수 구하기 -->
	<select id="countSpace" resultType="Integer">
		SELECT count(*) FROM space WHERE space_status != 2
	</select>
	
	<!-- 장소 리스트 조회 -->
	<select id="getSpaceList" resultType="com.gd.uspace.space.dto.SpaceDTO">
		SELECT space_no, space_name, space_type, space_point, space_address, space_region, space_latitude, space_longitude, space_min, 
			space_max, space_intro_content, space_guide_content, space_notice_content, space_regist_date, space_contact, space_status
			FROM space s
			WHERE space_status != 2
			ORDER BY space_regist_date DESC 
			LIMIT 10 OFFSET #{param1}
	</select>
	
	<!-- 장소별 예약건수 조회 -->
	<select id="getRsvCnt" parameterType="string" resultType="Integer">
	select count(*)
		from us_group
		where space_no = #{param1}
	</select>
		
	<!-- 장소 정보 등록 -->
	<insert id="addSpace"
		useGeneratedKeys="true" 
		keyColumn="space_no"
		keyProperty="space_no"
		parameterType="com.gd.uspace.space.dto.SpaceDTO">
		insert into space(space_name, space_type, space_point, space_address, space_region, space_latitude, space_longitude, space_min, space_max, 
								space_intro_content, space_guide_content, space_notice_content, space_contact, space_status)
			values(#{space_name},#{space_type},#{space_point},#{space_address},#{space_region},#{space_latitude},#{space_longitude},#{space_min},#{space_max},
						#{space_intro_content},#{space_guide_content},#{space_notice_content},#{space_contact},#{space_status})
	</insert>

	<!-- 운영 시간 저장 -->
	<insert id="addTimeTable">
		insert into spaceOperating(space_no, space_day, space_start_time, space_end_time)
			values(#{param1},#{param2},#{param3},#{param4})
	</insert>
	
	<!-- 사진 파일 저장 -->
	<insert id="uploadPhotos">
		insert into spaceImage(space_no, space_file_name, space_update_name, space_isMain)
			values(#{param1},#{param2},#{param3},#{param4})
	</insert>
	<!-- 장소 정보 조회 -->
	<select id="getSpaceInfo" resultType="com.gd.uspace.space.dto.SpaceDTO">
		SELECT * FROM space WHERE space_no = #{param1}
	</select>
	<!-- 장소 대표 사진 조회 -->
	<select id="getSpaceMainPhoto" resultType="com.gd.uspace.space.dto.SpaceImageDTO">
		SELECT * FROM spaceImage WHERE space_no = #{param1} AND space_isMain = 1
	</select>
	<!-- 장소 대표 제외한 나머지 사진 조회 -->
	<select id="getSpacePhotos" resultType="com.gd.uspace.space.dto.SpaceImageDTO">
		SELECT * FROM spaceImage WHERE space_no = #{param1} AND space_isMain = 0
	</select>	
	<!-- 장소 운영시간 조회 -->
	<select id="getSpaceOperating" resultType="com.gd.uspace.space.dto.SpaceOperatingDTO">
		SELECT * FROM spaceOperating WHERE space_no = #{param1}
	</select>
	<!-- 리뷰 목록 조회(필터링, 정렬, 페이징) -->
	<select id="getSpaceReview" parameterType="hashmap" resultType="com.gd.uspace.space.dto.SpaceReviewDTO">
		SELECT * FROM spaceReview sr
		WHERE sr.space_no = #{space_no}
		<if test="sort == '별점높은순'"> 
		ORDER BY review_score DESC
		</if>
		<if test="sort == '별점낮은순'">
		ORDER BY review_score ASC
		</if>
		<if test="sort == '최신순'">
		ORDER BY review_date DESC
		</if>
		<if test="sort == '과거순'">
		ORDER BY review_date ASC
		</if>
		<if test="page != null">
        LIMIT #{page}, 5
        </if> 
	</select>
	<!-- 리뷰 목록의 전체 페이지 갯수 조회 -->
	<select id="getReviewAllPageCount" resultType="int">
		SELECT CEIL(COUNT(review_date) / 5) FROM spaceReview WHERE space_no = #{param1}
	</select>
	<!-- 질문 목록 조회(필터링, 정렬, 페이징) -->
		<select id="getSpaceQna" parameterType="com.gd.uspace.space.dto.PaginationDTO" resultType="com.gd.uspace.space.dto.SpaceQuestionDTO">
		SELECT * FROM spaceQuestion sq 
		WHERE sq.space_no = #{space_no}
		<if test="sort == '최신순'">
		ORDER BY question_write_date DESC
		</if>
		<if test="sort == '과거순'">
		ORDER BY question_write_date ASC
		</if>
		<if test="page != null">
        LIMIT #{page}, 5
        </if> 
	</select>
	<!-- 해당 질문의 답변 목록 조회(필터링, 정렬, 페이징) -->
	<select id="getSpaceAnswer" resultType="com.gd.uspace.space.dto.SpaceAnswerDTO">
		SELECT * FROM spaceAnswer sa WHERE sa.space_question_no = #{param1} 
	</select>
	<!-- 질문 목록의 전체 페이지 갯수 조회 -->
	<select id="getQuestionAllPageCount" resultType="int">
		SELECT CEIL(COUNT(question_write_date) / 5) FROM spaceQuestion WHERE space_no = #{param1}
	</select>
	<!-- 질문 글 추가 -->
	<insert id="insertQuestion">
		INSERT INTO spaceQuestion (space_no,user_id,question_content) 
		VALUES (#{param1}, #{param2}, #{param3});
	</insert>
	<!-- 등록한 장소 정보 가져오기 -->
	<select id="getSpaceById" parameterType="int" resultType="com.gd.uspace.space.dto.SpaceDTO">
        SELECT * FROM space WHERE space_no = #{space_no}
    </select>
    <!-- 해당 장소의 예약 현황을 가져오기 -->  
	<select id="getReservationTimes" resultType="com.gd.uspace.reservation.dto.ReservationTime">
		SELECT 
			HOUR(group_starttime) AS start_hour, 
			HOUR(group_endtime) AS end_hour 
		FROM us_group WHERE space_no = #{param1} AND DATE(group_starttime) = #{param2}	
	</select>
    <update id="updateSpace" parameterType="com.gd.uspace.space.dto.SpaceDTO">
        UPDATE space
        SET
            space_name = #{space_name},
            space_type = #{space_type},
            space_point = #{space_point},
            space_region = #{space_region},
            space_address = #{space_address},
            space_latitude = #{space_latitude},
            space_longitude = #{space_longitude},
            space_max = #{space_max},
            space_min = #{space_min},
            space_intro_content = #{space_intro_content},
            space_contact = #{space_contact},
            space_guide_content = #{space_guide_content},
            space_notice_content = #{space_notice_content}
        WHERE
            space_no = #{space_no}
    </update>

	<!-- 사용자의 포인트 잔액 조회 -->
	<select id="getUserBalance" resultType="int">
		SELECT user_point FROM user WHERE user_id = #{param1}
	</select>
	<!-- 장소 대여 금액 조회 -->
	<select id="getSpacePoint" resultType="int">
		SELECT space_point FROM space WHERE space_no = #{param1}
	</select>
	<!-- 해당 장소의 모집중인 모임들을 조회한다 -->
	<select id="getGroupList" resultType="com.gd.uspace.group.dto.GroupDTO">
		SELECT * FROM us_group ug WHERE group_state = 0 AND space_no = #{param1}
		<if test="#{param2} != null">
        	LIMIT #{param2}, 4
        </if> 
	</select>
	<!-- 모임 목록의 전체 페이지 갯수 조회 -->
	<select id="getGroupAllPageCount" resultType="int">
		SELECT CEIL(COUNT(group_no) / 4) FROM us_group WHERE group_state = 0 AND space_no = #{param1}
	</select>
	<!-- 사용자의 포인트 잔액 더하기 -->
	<update id="addUserBalance">
		UPDATE user SET user_point = user_point + #{param2} WHERE user_id = #{param1}
	</update>
	<!-- 예약 등록 -->
	<insert id="registerGroup" 
		parameterType="com.gd.uspace.group.dto.GroupDTO"
		useGeneratedKeys="true"
		keyProperty="group_no"
		keyColumn="group_no">
		INSERT INTO us_group (space_no
			,user_id
			,group_name
			,group_state
			,group_create_date
			,group_people
			,group_introduce
			,group_caution
			,group_confirm
			,group_starttime
			,group_endtime
			,group_lowpeople
			,group_highpeople)
	    VALUES (
	        #{space_no}
	        ,#{user_id}
	        ,#{group_name}
	        ,#{group_state}
	        ,#{group_create_date}
	        ,#{group_people}
	        ,#{group_introduce}
	        ,#{group_caution}
	        ,#{group_confirm}
	        ,#{group_starttime}
	        ,#{group_endtime}
	        ,#{group_lowpeople}
	        ,#{group_highpeople}
	    )
	</insert>
	<!-- 거래 내역을 기록 -->
	<insert id="insertPointList" parameterType="com.gd.uspace.point.dto.PointDTO">
		INSERT INTO point (group_no, user_id, point_price, point_list, point_balance)
			VALUES (#{group_no}, #{user_id}, #{point_price}, #{point_list}, #{point_balance})
	</insert>

</mapper>